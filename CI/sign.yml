# [Template] Download built DLL artifacts, sign them, copy to UnityFolderPath folder, upload folder as Azure Artifact

parameters:
  ArtifactName: ''
  UnityFolderPath: ''
  Sign: false

steps:
- task: DownloadBuildArtifacts@0
  displayName: Download built DLLs
  inputs:
    downloadType: specific
    downloadPath: $(Build.SourcesDirectory)/Temp

# required for code signing
- task: ComponentGovernanceComponentDetection@0
  inputs:
    scanType: 'Register'
    failOnAlert: true

- task: PkgESCodeSign@10
  displayName: Sign binaries
  condition: ${{ parameters.Sign }}
  inputs:
    signConfigXml: $(PlaneFinding)/SignConfig.xml
    inPathRoot: $(Build.SourcesDirectory)/Temp/${{ parameters.ArtifactName }}
    outPathRoot: ${{ parameters.UnityFolderPath }}/Plugins
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)

- task: CopyFiles@2
  displayName: Copy PlaneFinding DLLs to package directory
  condition: not(${{ parameters.Sign }})
  inputs:
    sourceFolder: $(Build.SourcesDirectory)/Temp/${{ parameters.ArtifactName }}
    contents: '**/*.dll'
    targetFolder: ${{ parameters.UnityFolderPath }}/Plugins

- task: PublishBuildArtifacts@1
  displayName: Publish PlaneFinding UPM folder
  inputs:
    pathToPublish: ${{ parameters.UnityFolderPath }}
    artifactName: UPMFolder_${{ parameters.ArtifactName }}